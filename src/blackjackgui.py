import tkinter as tk
from tkinter import *
from PIL import Image, ImageTk
from deck import Deck
from handchecker import HandChecker
import time
import os
import sys



class BlackjackGUI(tk.Tk):
    def __init__(self):
        super().__init__()

        # Change working directory to src
        os.chdir(sys.path[0])
        
        # Absolute path to the card images
        cardspath = os.path.abspath("gui/cards")
        
        self.handchecker = HandChecker()
        
        d_hand = []
        p_hand = []


        # Title and root
        self.title('Blackjack')
        self.geometry('1200x800')
        self.configure(background="green")

        temp_frame = Frame(self, bg="green")
        temp_frame.pack(pady=20)

        # Card frames
        house_frame = LabelFrame(temp_frame, text="House", bd=0)
        house_frame.grid(row=0, column=0, ipadx=20)

        player_frame = LabelFrame(temp_frame, text="Player", bd=0)
        player_frame.grid(row=1, column=0, pady=20, ipadx=20)

        # Insert blank cards into frames

        # House
        house_label_1 = Label(house_frame, text='')
        house_label_1.grid(row=0,column=0)

        house_label_2 = Label(house_frame, text='')
        house_label_2.grid(row=0,column=1)

        house_label_3 = Label(house_frame, text='')
        house_label_3.grid(row=0,column=2)

        house_label_4 = Label(house_frame, text='')
        house_label_4.grid(row=0,column=3)

        house_label_5 = Label(house_frame, text='')
        house_label_5.grid(row=0,column=4)

        house_label_6 = Label(house_frame, text='')
        house_label_6.grid(row=0,column=4)

        # Player
        player_label_1 = Label(player_frame, text='')
        player_label_1.grid(row=0,column=0)

        player_label_2 = Label(player_frame, text='')
        player_label_2.grid(row=0,column=1)

        player_label_3 = Label(player_frame, text='')
        player_label_3.grid(row=0,column=2)

        player_label_4 = Label(player_frame, text='')
        player_label_4.grid(row=0,column=3)

        player_label_5 = Label(player_frame, text='')
        player_label_5.grid(row=0,column=4)

        player_label_6 = Label(player_frame, text='')
        player_label_6.grid(row=0,column=4)


        # Resize function for cards
        def resize_card(card):
            

            card_image = Image.open(card)

            resized_card = card_image.resize((150,218))
            global card_image_tk
            card_image_tk = ImageTk.PhotoImage(resized_card)

            return card_image_tk


        def hide_deal_button():
            deal_button.grid_forget()

        def show_deal_button():
            deal_button.grid(row=0,column=0) 

        def show_hit_button():
            hit_button.grid(row=0,column=1,padx=22)

        def hide_hit_button():
            hit_button.grid_forget()            

        def show_stand_button():
            stand_button.grid(row=0,column=2)

        def hide_stand_button():
            stand_button.grid_forget()


        # Deal cards function
        def deal_cards():

            # Clear hands
            self.deck = Deck()
            p_hand.clear()
            d_hand.clear()
            
            # Card position resets on deal_cards function
            global d_card_position, p_card_position
            self.d_card_position = 0
            self.p_card_position = 0

            # Clear all cards
            house_label_1.config(image="")
            house_label_2.config(image="")
            house_label_3.config(image="")
            house_label_4.config(image="")
            house_label_5.config(image="")
            house_label_6.config(image="")

            player_label_1.config(image="")
            player_label_2.config(image="")
            player_label_3.config(image="")
            player_label_4.config(image="")
            player_label_5.config(image="")
            player_label_6.config(image="")

            # Dealers first and hidden card
            global hidden_card
            hidden_card = self.deck.deal_cards(d_hand)
            
            # Saving the hidden card image for later reveal
            global hidden_card_image
            hidden_card_image = resize_card(f'{cardspath}/{hidden_card}.png')
            
            # Cardback image
            global cardback_image
            cardback_image = resize_card(f'{cardspath}/cardback.png')
            house_label_1.config(image=cardback_image)

            # Dealers second card
            house_second_card = self.deck.deal_cards(d_hand)

            global house_image_2nd
            house_image_2nd = resize_card(f'{cardspath}/{house_second_card}.png')
            house_label_2.config(image=house_image_2nd)
            
            # Players cards
            player_first_card = self.deck.deal_cards(p_hand)
            player_second_card = self.deck.deal_cards(p_hand)

            # First
            global player_image_1st
            player_image_1st = resize_card(f'{cardspath}/{player_first_card}.png')
            player_label_1.config(image=player_image_1st)
            
            # Second
            global player_image_2nd
            player_image_2nd = resize_card(f'{cardspath}/{player_second_card}.png')
            player_label_2.config(image=player_image_2nd)

            print(self.handchecker.hand_total(p_hand))
            if self.handchecker.hand_total(p_hand) == 21:
                blackjack()
            


        def hit():

            if self.p_card_position < 4:
                
                try:
                    p_card = self.deck.deal_cards(p_hand)

                    global player_image1, player_image2, player_image3, player_image4
                    
                    if self.p_card_position == 0:
                        player_image1 = resize_card(f'{cardspath}/{p_card}.png')
                        player_label_3.config(image=player_image1)

                    elif self.p_card_position == 1:
                        player_image2 = resize_card(f'{cardspath}/{p_card}.png')
                        player_label_4.config(image=player_image2)

                    elif self.p_card_position == 2:
                        player_image3 = resize_card(f'{cardspath}/{p_card}.png')
                        player_label_5.config(image=player_image3)

                    elif self.p_card_position == 3:
                        player_image4 = resize_card(f'{cardspath}/{p_card}.png')
                        player_label_6.config(image=player_image4)    

                    self.p_card_position += 1

                    print(self.handchecker.hand_total(p_hand))

                    if self.handchecker.bust_hand(self.handchecker.hand_total(p_hand)):
                        
                        bust()

                    elif self.handchecker.hand_total(p_hand) == 21:
                        player_hits_21()

 
                    

                except:
                    pass


        def stand():
            
            hide_hit_button()
            hide_stand_button()

            dealer_hit()




        def dealer_hit():
            # Reveal the "hole card"
            house_label_1.config(image=hidden_card_image)
            # Slows dealer down a bit
            sleep()

            if self.handchecker.hand_total(d_hand) == 21:
                standoff()
            elif self.handchecker.hand_total(d_hand) >= 17:
                standoff() 
            else:

                while self.handchecker.hand_total(d_hand) < 17:


                    if self.d_card_position < 4:
                        
                        try:
                            d_card = self.deck.deal_cards(d_hand)

                            global house_image1, house_image2, house_image3, house_image4
                            
                            if self.d_card_position == 0:
                                house_image1 = resize_card(f'{cardspath}/{d_card}.png')
                                house_label_3.config(image=house_image1)

                            elif self.d_card_position == 1:
                                house_image2 = resize_card(f'{cardspath}/{d_card}.png')
                                house_label_4.config(image=house_image2)

                            elif self.d_card_position == 2:
                                house_image3 = resize_card(f'{cardspath}/{d_card}.png')
                                house_label_5.config(image=house_image3)

                            elif self.d_card_position == 3:
                                house_image4 = resize_card(f'{cardspath}/{d_card}.png')
                                house_label_6.config(image=house_image4)    

                            self.d_card_position += 1

                            print(self.handchecker.hand_total(d_hand))

                            if self.handchecker.bust_hand(self.handchecker.hand_total(d_hand)):
                                
                                house_bust()

                            elif self.handchecker.hand_total(d_hand) == 21:
                                lose()
                            else:
                                standoff()
                            

                        except:
                            pass
                

        def bust():
            # Reveal the "hole card"
            house_label_1.config(image=hidden_card_image)
            print("Bust!")
            hide_hit_button()
            hide_stand_button()
            show_deal_button()
            lose()

        def player_hits_21():
            dealer_hit()

        def standoff():
            if self.handchecker.hand_total(p_hand) == self.handchecker.hand_total(d_hand):
                push()
            elif self.handchecker.hand_total(p_hand) > self.handchecker.hand_total(d_hand):
                win()
            else:
                lose()

        def push():
            print("Push")
            hide_hit_button()
            hide_stand_button()
            show_deal_button()


        def blackjack():
            # Reveal the "hole card"
            house_label_1.config(image=hidden_card_image)

            if self.handchecker.hand_total(d_hand) != 21:
                print("Blackjack!")
                win()
            else:
                push()    

        def house_bust():
            print("House busts!")
            hide_hit_button()
            hide_stand_button()
            show_deal_button()
            win()
        
        def win():
            hide_hit_button()
            hide_stand_button()
            show_deal_button()
            print("You Win!")
            
        
        def lose():
            print("You Lose")
            hide_hit_button()
            hide_stand_button()
            show_deal_button()

        def sleep():
            time.sleep(0.4)

        # Frame for buttons
        button_frame = Frame(self, bg="green")
        button_frame.pack(pady=20)


        # Buttons

        # Deal button(hides when clicked)
        deal_button = Button(button_frame, text="Deal Cards", font=("Raleway", 14))
        deal_button.configure(command=lambda:  [deal_cards(), hide_deal_button(), show_hit_button(), show_stand_button()])
        deal_button.grid(row=0,column=0)

        # Hit button
        hit_button = Button(button_frame, text="Hit", font=("Raleway", 14))
        hit_button.configure(command=lambda: hit())

        # Stand Button
        stand_button = Button(button_frame, text="Stand", font=("Raleway", 14))
        stand_button.configure(command=lambda: stand())





        